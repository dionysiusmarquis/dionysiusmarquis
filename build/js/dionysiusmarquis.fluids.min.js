"undefined"==typeof dm&&(dm=new Object),"undefined"==typeof dm.ShaderLib&&(dm.ShaderLib=new Object),"undefined"==typeof dm.Fluids&&(dm.Fluids=new Object),"undefined"==typeof dm.Fluids.Shaders&&(dm.Fluids.Shaders=new Object),"undefined"==typeof dm.Fluids.ShaderMaterials&&(dm.Fluids.ShaderMaterials=new Object),dm.Fluids.Simulator=function(e){function t(e,t,r,l,d,m,o,h,c){l=l?l*R.sampling:0,d=d?-d*R.sampling:0,m=m?m*R.sampling:r.image.width*R.sampling,o=o?o*R.sampling:r.image.height*R.sampling;var f,y=m/R.width,v=o/R.height,x=l/R.width*2+(y-1),T=d/R.height*2+(1-v);h?(f=b.clone(),f.uniforms.tDiffuse.value=r,f.uniforms.color.value=h,R.blendImpulse?f.uniforms.premultiplied.value=1:f.uniforms.premultiplied.value=0):R.blendImpulse?(f=new THREE.MeshBasicMaterial,f.map=r):(f=S.clone(),f.uniforms.tDiffuse.value=r),f.transparent=!0;var w=new THREE.Mesh(n,f);w.userData=e,w.scale.set(y,v,1),w.position.set(x,T,0);var E,g;switch(t){case"impulsedensity":c?(w.renderOrder=2,f.blending=THREE.AdditiveBlending):R.blendImpulse&&(f.blending=THREE.CustomBlending,f.blendSrc=THREE.SrcAlphaFactor,f.blendDst=THREE.OneMinusSrcAlphaFactor,f.blendEquation=THREE.AddEquation),E=i;break;case"impulsetemperature":E=a;break;case"obstacle":E=s,g=p.obstacles.texture;break;default:console.error("Wrong type specified.")}if(e){var O=D.getObject(e,E);O&&E.remove(O)}return E.add(w),g&&D.render(E,u,g),w}THREE.WebGLRenderer.call(this,{antialiasing:!1,alpha:!0,premultipliedAlpha:!0});var r,i,a,s,u,n,l,d,m,o,p,h,c,f,y,v,x,T,w,E,b,g,S,D=this,R=this.settings=new dm.Fluids.Settings,O=(new Date).getTime();this.impulseObjects=new Array,this.obstacleObjects=new Array,this.applyCircleImpulse=!1,this.applyTextureImpulse=!1,this.autoClearImpulse=!1,this.autoClearObstacles=!1,this.isInitialized=!1,this.isSupported=Detector.webgl&&this.supportsHalfFloatTextures(),this.getObject=function(e,t){var r;for(r=0;r<t.children.length;r++)if(t.children[r].userData==e)return t.children[r]},this.getObjectIndex=function(e,t){var r;for(r=0;r<t.children.length;r++)if(t.children[r].userData==e)return r},this.addCircleImpulse=function(e,t,r,i,a,s){return},this.addBoundary=function(){w.uniforms.Boundary.value=[R.boundaryTop,R.boundaryRight,R.boundaryBottom,R.boundaryLeft];var e=new THREE.Mesh(n,w);e.userData="boundary",s.add(e)},this.addObstacle=function(e,r,i,a,s,u,n){t(e,"obstacle",r,i,a,s,u,n)},this.addImpulse=function(e,r,i,a,s,u,n,l){t(e,"impulsedensity",r,i,a,s,u,l),t(e,"impulsetemperature",r,i,a,s,u,n||new THREE.Vector4(R.impulseTemperature.x,R.impulseTemperature.y,R.impulseTemperature.z,1))},this.addImpulseOverlay=function(e,r,i,a,s,u,n,l){t(e,"impulsedensity",r,i,a,s,u,l,!0),t(e,"impulsetemperature",r,i,a,s,u,n||new THREE.Vector4(R.impulseTemperature.x,R.impulseTemperature.y,R.impulseTemperature.z,1),!0)},this.clearImpulse=function(e){e=e||new Array;for(var t,r=0;i.children.length>r;)t=i.children[r],"density"!=t.userData&&-1==e.indexOf(t.userData)?i.remove(t):r++;for(r=0;a.children.length>r;)t=a.children[r],"temperature"!=t.userData&&-1==e.indexOf(t.userData)?a.remove(t):r++},this.clearObstacles=function(e){e=e||new Array;for(var t,r=0;s.children.length>r;)t=s.children[r],"boundary"!=t.userData&&-1==e.indexOf(t.userData)?s.remove(t):r++;this.render(s,u,p.obstacles.texture)},this.init=function(e,t,O){this.isInitialized=!0,this.isSupported&&(e=e||this.domElement.width,t=t||this.domElement.height,R.setSize(e,t),p=new dm.Fluids.Textures(R),r=new THREE.Scene,i=new THREE.Scene,a=new THREE.Scene,s=new THREE.Scene,u=new THREE.OrthographicCamera(-1,1,1,-1,0,1),n=new THREE.PlaneBufferGeometry(2,2),l=new THREE.Mesh(n,null),o=new THREE.MeshBasicMaterial,l.material=o,c=new dm.Fluids.ShaderMaterials.Advect(R,p),f=new dm.Fluids.ShaderMaterials.Buoyancy(R,p),y=new dm.Fluids.ShaderMaterials.ApplyImpulse(R,p),v=new dm.Fluids.ShaderMaterials.ComputeDivergence(R,p),x=new dm.Fluids.ShaderMaterials.Jacobi(R,p),T=new dm.Fluids.ShaderMaterials.SubtractGradient(R,p),w=new dm.Fluids.ShaderMaterials.Boundary(R,p),E=new dm.Fluids.ShaderMaterials.Vignette(R,p),b=new THREE.ShaderMaterial(dm.ShaderLib.OverrideColor),g=new THREE.ShaderMaterial(dm.ShaderLib.PremultiplyAlpha),S=new THREE.ShaderMaterial(dm.ShaderLib.UnpremultiplyAlpha),h=[c,f,y,v,x,T,w,E],this.clearTarget(p.density.texture),this.clearTarget(p.temperature.texture),this.clearTarget(p.obstacles.texture),r.add(l),d=new THREE.Mesh(n,S.clone()),d.renderOrder=1,d.userData="density",d.material.transparent=!0,i.add(d),m=new THREE.Mesh(n,S.clone()),m.renderOrder=1,m.userData="temperature",m.material.transparent=!0,a.add(m),D.addBoundary(),O!==!1&&this.setSize(e,t))},this.simulate=function(e){if(this.isInitialized){var t=(new Date).getTime()-O;if(!e&&-1!=R.fps&&t<1e3/R.fps)return!1;l.material=c,c.uniforms.VelocityTexture.value=p.velocity.texture,c.uniforms.SourceTexture.value=p.velocity.texture,c.uniforms.Dissipation.value=R.velocityDissipation,this.render(r,u,p.velocity.texture2),p.velocity.swapTexture(),c.uniforms.VelocityTexture.value=p.velocity.texture,c.uniforms.SourceTexture.value=p.temperature.texture,c.uniforms.Dissipation.value=R.temperatureDissipation,this.render(r,u,p.temperature.texture2),p.temperature.swapTexture(),c.uniforms.VelocityTexture.value=p.velocity.texture,c.uniforms.SourceTexture.value=p.density.texture,c.uniforms.Dissipation.value=R.densityDissipation,this.render(r,u,p.density.texture2),p.density.swapTexture(),l.material=f,f.uniforms.Velocity.value=p.velocity.texture,f.uniforms.Temperature.value=p.temperature.texture,f.uniforms.Density.value=p.density.texture,f.uniforms.Sigma.value=R.invertBuoyancy?-R.smokeBuoyancy:R.smokeBuoyancy,f.uniforms.Kappa.value=R.smokeWeight,this.render(r,u,p.velocity.texture2),p.velocity.swapTexture(),this.applyCircleImpulse&&(l.material=y,y.uniforms.Sampler.value=p.temperature.texture,y.uniforms.FillColor.value=R.circleImpulseTemperature||R.impulseTemperature,y.uniforms.Radius.value=R.circleImpulseRadius,this.render(r,u,p.temperature.texture2),p.temperature.swapTexture(),y.uniforms.Sampler.value=p.density.texture,y.uniforms.FillColor.value=R.circleImpulseDensity||R.impulseDensity,l.material=y,this.render(r,u,p.density.texture2),p.density.swapTexture()),this.applyTextureImpulse&&i.children.length>1&&(m.material.uniforms.tDiffuse.value=p.temperature.texture,this.render(a,u,p.temperature.texture2),p.temperature.swapTexture(),d.material.uniforms.tDiffuse.value=p.density.texture,this.render(i,u,p.density.texture2),p.density.swapTexture()),l.material=v,v.uniforms.Obstacles.value=p.obstacles.texture,v.uniforms.Velocity.value=p.velocity.texture,this.render(r,u,p.divergence.texture),l.material=x,x.uniforms.Obstacles.value=p.obstacles.texture,this.clearTarget(p.pressure.texture1,!0,!0,!0);var s;for(s=0;s<R.numJacobiIterations;s++)x.uniforms.Pressure.value=p.pressure.texture,this.render(r,u,p.pressure.texture2,0===s),p.pressure.swapTexture();return l.material=T,T.uniforms.Obstacles.value=p.obstacles.texture,T.uniforms.Velocity.value=p.velocity.texture,T.uniforms.Pressure.value=p.pressure.texture,this.render(r,u,p.velocity.texture2),p.velocity.swapTexture(),R.enableVignette?(l.material=E,E.uniforms.tDiffuse.value=p.density.texture):(l.material=o,o.map=p.density.texture),this.render(r,u),this.autoClearImpulse&&this.clearImpulse(),this.autoClearObstacles&&this.clearObstacles(),O=(new Date).getTime(),!0}},this.setSize=function(e,t,r){if(r||this.domElement.width!=e||this.domElement.height!=t){this.domElement.width=e,this.domElement.height=t,this.domElement.style.width=e+"px",this.domElement.style.height=t+"px",this.setViewport(0,0,e,t),R.setSize(e,t),this.isInitialized||this.init(e,t,!1),p.update();var i,a;for(i=h.length-1;i>=0;i--)a=h[i],a.update(R,p);this.clearTarget(p.density.texture),this.clearTarget(p.temperature.texture),this.clearTarget(p.obstacles.texture)}},this.setSampling=function(e){R.sampling=e,this.setSize(R.originWidth,R.originHeight,!0),this.render(s,u,p.obstacles.texture)}},dm.Fluids.Simulator.prototype=Object.create(THREE.WebGLRenderer.prototype);